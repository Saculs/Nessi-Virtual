<!DOCTYPE html>
<html lang="en">

<head>
	<title>Nessi Nezzila</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link type="text/css" rel="stylesheet" href="examples/main.css">

	<link rel='shortcut icon' href='favicon.ico' type='image/png' />
	<link rel="icon" sizes="192x192" href="favicon.ico">
	<link rel="manifest" href="mani.webmanifest" />

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

	<link rel="stylesheet" type="text/css" href="loading-bar.css" />
	<script type="text/javascript" src="loading-bar.js"></script>




	<style type="text/css">
		.ldBar path.mainline {
			stroke-width: 10;
			stroke: #f1f2f3;
		}

		.ldBar path.baseline {
			stroke-width: 18;
			stroke: #272727;
		}

		#myProgress {
			width: 40%;
			background-color: black;
			outline-style: outset;
			outline-width: 1px;
			outline-color: white;
			padding: 2px;
			position: absolute;
			bottom: 30%;
			left: 30%;
		}

		#myBar {
			width: 1%;
			height: 20px;
			background-color: white;
		}

		#crossHair {
			width: 2%;
			top: 50%;
			left: 50%;
			position: absolute;
			margin-right: -50%;
			transform: translate(-50%, -50%);
			display: block;
		}

		#loadText {
			font-size: 36px;
			position: absolute;
			top: 30%;
			left: 0;
			right: 0;
		}

		@keyframes rotation {
			from {
				transform: rotate(0deg);
			}

			to {
				transform: rotate(359deg);
			}
		}
	</style>


</head>

<body>
	<img src="mouse.png" id="crossHair">
	<div id="blocker">

		<div id="instructions">
			<div>

				<span id='loadText'>Loading...</br><img src="./SomaIcov1.png"
						style="width: 150px; height:150px" /></span>

			</div>
			<div id="myProgress">
				<div id="myBar"></div>
			</div>

			<br /><br />
			Move: ARROWS / WASD<br />
			Look: MOUSE

		</div>

	</div>
	<script id="vertexShader" type="x-shader/x-vertex">
		uniform vec3 viewVector;
		uniform float c;
		uniform float p;
		varying float intensity;
		void main() 
		{
			vec3 vNormal = normalize( normalMatrix * normal );
			vec3 vNormel = normalize( normalMatrix * viewVector );
			intensity = pow( c - dot(vNormal, vNormel), p );
			
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
		}
		</script>
		
		<!-- fragment shader a.k.a. pixel shader -->
		<script id="fragmentShader" type="x-shader/x-vertex"> 
		uniform vec3 glowColor;
		varying float intensity;
		void main() 
		{
			vec3 glow = glowColor * intensity;
			gl_FragColor = vec4( glow, 1.0 );
		}
		</script>


	<script type="module">

		(function () { var script = document.createElement('script'); script.onload = function () { var stats = new Stats(); document.body.appendChild(stats.dom); requestAnimationFrame(function loop() { stats.update(); requestAnimationFrame(loop) }); }; script.src = '//mrdoob.github.io/stats.js/build/stats.min.js'; document.head.appendChild(script); })()

		import * as THREE from './build/three.module.js';

		import { PointerLockControls } from './examples/jsm/controls/PointerLockControls.js';
		import { GLTFLoader } from './examples/jsm/loaders/GLTFLoader.js';

		import { EffectComposer } from './examples/jsm/postprocessing/EffectComposer.js';
		import { RenderPass } from './examples/jsm/postprocessing/RenderPass.js';
		import { ShaderPass } from './examples/jsm/postprocessing/ShaderPass.js';
		import { UnrealBloomPass } from './examples/jsm/postprocessing/UnrealBloomPass.js';
		import { FXAAShader } from './examples/jsm/shaders/FXAAShader.js';

		import { FireShader } from './FireShader.js';

		import {
			Euler,
			EventDispatcher,
			Vector3
		} from "./build/three.module.js";

		var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

		var loader = new GLTFLoader();

		var camera, scene, scene1, scene2, scene3, renderer, controls;



		var mixer, mixer2, mixer3;



		var tutorial = true;
		var transition = true;



		var rocks, door, gasSphere;


		var currentScene;

		var index = 2;

		var scene0loaded = false;

		var scene1loaded = false;

		var scene2loaded = true;

		var scene3loaded = false;

		var crossHair;

		var objects = [];

		var rocksGeo = [];
		var rocksMats = [];

		var raycaster;
		var mouse;

		var clock;
		var fire, fire2, fire3;


		var moveForward = false;
		var moveBackward = false;
		var moveLeft = false;
		var moveRight = false;
		var canJump = false;

		var prevTime = performance.now();
		var velocity = new THREE.Vector3();
		var direction = new THREE.Vector3();
		var vertex = new THREE.Vector3();
		var color = new THREE.Color();

		var manager = new THREE.LoadingManager();

		manager.onProgress = function (item, loaded, total) {
			console.log(item, loaded, total);
		};
		manager.onLoad = function () {
			console.log('all items loaded');
		};
		manager.onError = function () {
			console.log('there has been an error');
		};

		var elem = document.getElementById("myBar");
		var loading = document.getElementById("myProgress");

		var Fire = function (fireTex, color) {

			var fireMaterial = new THREE.ShaderMaterial({
				defines: FireShader.defines,
				uniforms: THREE.UniformsUtils.clone(FireShader.uniforms),
				vertexShader: FireShader.vertexShader,
				fragmentShader: FireShader.fragmentShader,
				transparent: true,
				depthWrite: false,
				depthTest: true
			});

			// initialize uniforms 

			fireTex.magFilter = fireTex.minFilter = THREE.LinearFilter;
			fireTex.wrapS = fireTex.wrapT = THREE.ClampToEdgeWrapping;

			fireMaterial.uniforms.fireTex.value = fireTex;
			fireMaterial.uniforms.color.value = color || new THREE.Color(0xeeeeee);
			fireMaterial.uniforms.invModelMatrix.value = new THREE.Matrix4();
			fireMaterial.uniforms.scale.value = new THREE.Vector3(1, 1, 1);
			fireMaterial.uniforms.seed.value = Math.random() * 19.19;
			fireMaterial.uniforms.magnitude.value = 2.6;


			THREE.Mesh.call(this, new THREE.BoxGeometry(1.0, 1.0, 1.0), fireMaterial);
		};

		Fire.prototype = Object.create(THREE.Mesh.prototype);
		Fire.prototype.constructor = THREE.Fire;

		Fire.prototype.update = function (time) {

			var invModelMatrix = this.material.uniforms.invModelMatrix.value;

			this.updateMatrixWorld();
			invModelMatrix.getInverse(this.matrixWorld);

			if (time !== undefined) {
				this.material.uniforms.time.value = time;
			}

			this.material.uniforms.invModelMatrix.value = invModelMatrix;

			this.material.uniforms.scale.value = this.scale;
		};

		init();
		animate();



		function getRadian(x) {
			return (Math.PI * x) / 180;
		}

		function initEnv() {
			var geometry = new THREE.BoxGeometry(1400, 200, 2);
			var material = new THREE.MeshLambertMaterial({ color: 0x111111 });
			var cube = new THREE.Mesh(geometry, material);
			cube.position.set(100, 20, -103);
			//scene.add(cube);

			var light = new THREE.PointLight(0xFFFFFF, 1, 200);
			light.position.set(- 0, 35, 80);
			scene.add(light);
		}

		function initUfo() {

			scene0loaded = true;
			initEnv();
			var intloader = new GLTFLoader(manager);
			intloader.load("models/interior8.glb", function (gltf) {
				var int = gltf.scene;

				int.scale.set(12, 12, 12);

				int.position.set(- 0, 0.50, 30);
				int.rotation.y = getRadian(-90);

				int.visible = true;
				var floorMaterial = new THREE.MeshStandardMaterial({ side: THREE.DoubleSide, color: 0x000000, roughness: 0, specular: 0 });
				int.traverse(function (o) {
					if (o.isMesh) {
						console.log("interrior");
						if (o.name == 'Walls') {
							o.material = floorMaterial;
						} else if (o.name == "PlaneTop") {
							var huTex = new THREE.TextureLoader().load("textures/UFO.png");
							var huMat = new THREE.MeshPhongMaterial({ map: huTex, transparent: true, opacity: 1, side: THREE.DoubleSide });
							o.material = huMat;
						}
					}
				});
				scene.add(int);
				loaded();
			},
				// called while loading is progressing
				function (xhr) {
					var prc = Math.floor(xhr.loaded / 25107276 * 100);
					console.log('interior ' + xhr + ' loaded');

					updateLoadBar(prc);
				}
			);

			var doorloader = new GLTFLoader(manager);
			doorloader.load("models/DoorRetopo.glb", function (gltf) {
				var door = gltf.scene;

				door.scale.set(2, 2, 2);

				door.position.set(-55, 0, 5);
				door.rotation.y = getRadian(-45);

				door.visible = true;



				door.traverse(function (o) {
					if (o.isMesh) {
						console.log("door");
						o.castShadow = true;
					}
				});
				scene.add(door);
				loaded();
			},
				// called while loading is progressing
				function (xhr) {
					console.log('door ' + (xhr.loaded) + '% loaded');
					var prc = Math.floor(xhr.loaded / 3027156 * 100);

				}
			);

			var babyloader = new GLTFLoader(manager);
			babyloader.load("models/Puppe1R.glb", function (gltf) {
				var baby = gltf.scene;
				var z = 0;
				baby.scale.set(7, 7, 7);

				baby.position.set(- 0, 1, 30);
				baby.rotation.y = getRadian(-90);

				baby.visible = true;

				baby.traverse(function (o) {
					if (o.isMesh) {
						console.log("babyerrior");
						o.material.spaculer = 1;
					}
				});
				scene.add(baby);
				loaded();
			},
				// called while loading is progressing
				function (xhr) {
					//var prc = Math.floor(xhr.loaded / 25107276 * 100);
					console.log('babyerior ' + xhr + ' loaded');

					//updateLoadBar(prc);
				}
			);

		}

		function updateLoadBar(prc) {
			elem.style.width = prc + "%";
			$("#loadText").html(prc + '% loading<br><img src="./SomaIcov1.png" style="width: 150px; height:150px; animation: rotation 3s infinite linear;"/>');
			/*
			if (prc == 100) loading.style.display = 'none';
			else loading.style.display = 'block';
			*/
		}

		function loaded() {
			if (tutorial == true) {
				$("#loadText").html('loaded<br/>click To Enter<br/><img src="./SomaIcov1.png" style="width: 150px; height:150px; animation: rotation 3s infinite linear;"/>');
				tutorial = false;

			} else {
				$("#loadText").html('loaded<br/>LOL');
				/*
				controls.lock();
				console.log("touchstart");
				instructions.style.display = 'none';
				blocker.style.display = 'none';
				*/

			}

		}


		function goToScene(txt) {
			console.log("go To Scene" + txt);
			camera.position.y = 10;
			camera.position.z = 30;
			var euler = new Euler(0, 0, 0, 'YXZ');
			camera.quaternion.setFromEuler(euler);

			switch (txt) {
				case "Space":
					index = 2;
					if (scene2loaded == false) {
						updateLoadBar(0);
						initScene2();
					} else loaded();

					currentScene = scene2;
					break;
				case "Fire":
					index = 1;
					if (scene1loaded == false) {
						updateLoadBar(0);
						initScene1();
					} else loaded();
					currentScene = scene1;
					break;
				case "UFO":
					index = 0;
					if (scene0loaded == false) {
						initScene0();
						updateLoadBar(0);
					} else loaded();
					currentScene = scene;
					break;
				case "AtomGas":
					index = 3;
					if (scene3loaded == false) {
						initScene3();
						updateLoadBar(0);
					} else loaded();
					currentScene = scene3;
					break;
				default:
					switchScenes();
			}

			currentScene.add(controls.getObject());

		}

		function switchScenes() {
			camera.position.y = 10;
			camera.position.z = 30;
			console.log("switch scenes");
			if (currentScene == scene) {
				if (scene1loaded == false) initScene1();
				currentScene = scene1;
			} else if (currentScene == scene1) {
				if (scene2loaded == false) initScene2();
				currentScene = scene2;
			}
			else if (currentScene == scene2) {
				if (scene3loaded == false) initScene3();
				currentScene = scene3;
			}
			else { currentScene = scene; }
		}

		function initScene0() {
			initUfo();
		}

		function initScene1() {
			scene1.add(controls.getObject());
			scene1loaded = true;

			var amblight = new THREE.AmbientLight(0xFFFFFf, 0.1);
			scene1.add(amblight);

			var light = new THREE.HemisphereLight(0xeeeeff, 0.3, 0.75);
			light.position.set(0.5, 1, 0.75);
			//scene1.add(light);

			var ufolight = new THREE.PointLight(0xeeeeff, 30, 50);
			ufolight.position.set(-70, 55, -100);
			scene1.add(ufolight);

			var light2 = new THREE.PointLight(0xf9c59d, 2, 60);
			light2.position.set(10, 30, 30);
			scene1.add(light2);

			var floorGeometry = new THREE.PlaneBufferGeometry(2000, 2000, 100, 100);
			floorGeometry.rotateX(- Math.PI / 2);
			var floorMaterial = new THREE.MeshLambertMaterial({ side: THREE.DoubleSide, color: 0x000000 });

			var floor = new THREE.Mesh(floorGeometry, floorMaterial);

			//scene1.add(floor);

			var light3 = new THREE.PointLight(0xd31313, 5, 26);
			light3.position.set(0, 15, -30);
			scene1.add(light3);






			var somaloader = new GLTFLoader(manager);
			somaloader.load("models/somaTierenRetopoJPG.glb", function (gltf) {
				var soma = gltf.scene;

				soma.scale.set(0.3, 0.3, 0.3);

				//soma.position.set(- 160, 6, 80);
				soma.rotation.y = getRadian(-90);

				soma.visible = true;
				soma.position.set(0, 0, 20);



				soma.traverse(function (o) {
					if (o.isMesh) {
						console.log("soma");
					}
				});
				scene1.add(soma);
				loaded();
			},
				// called while loading is progressing
				function (xhr) {
					console.log('soma ' + (xhr.loaded) + 'loaded');
					var prc = Math.floor(xhr.loaded / 4372972 * 100);

					updateLoadBar(prc);
				}
			);

			var bildloader = new GLTFLoader(manager);
			bildloader.load("models/FireBilds1.glb", function (gltf) {
				var bild = gltf.scene;

				bild.scale.set(0.3, 0.3, 0.3);
				bild.position.set(-40, 1, 50);
				

				bild.rotation.y = getRadian(-90);

				bild.visible = true;

				bild.traverse(function (o) {
					if (o.isMesh) {
						console.log("bild");
					}
				});
				scene1.add(bild);
				loaded();
			},
				// called while loading is progressing
				function (xhr) {
					console.log('bild ' + (xhr.loaded) + '% loaded');
					var prc = Math.floor(xhr.loaded / 18102840 * 100);

				}
			);


			var Debrisloader = new GLTFLoader(manager);
			Debrisloader.load("models/Debris2.glb", function (gltf) {
				var Debris = gltf.scene;

				Debris.scale.set(20, 20, 20);

				Debris.position.set(-10, 0, 40);
				Debris.rotation.y = getRadian(-90);

				Debris.visible = true;

				var geometry;
				var material;

				Debris.traverse(function (o) {
					if (o.isMesh) {
						console.log("Debris");
						geometry = o.geometry;
						material = o.material;
					}
				});

				//material that the geometry will use 

				var doorloader = new GLTFLoader(manager);
				doorloader.load("models/DoorRetopo.glb", function (gltf) {
					var door = gltf.scene;

					door.scale.set(5, 5, 5);

					door.position.set(20, 0, -10);
					door.rotation.y = getRadian(45);

					door.visible = true;



					door.traverse(function (o) {
						if (o.isMesh) {
							console.log("door");
							o.castShadow = true;
						}
					});
					scene1.add(door);
					loaded();
				},
					// called while loading is progressing
					function (xhr) {
						console.log('door ' + (xhr.loaded) + '% loaded');
						var prc = Math.floor(xhr.loaded / 3027156 * 100);

					}
				);


				makeInstanced(geometry, material);

				//scene1.add(Debris);
				$("#loadText").html('loaded<br>');
			},
				// called while loading is progressing
				function (xhr) {
					console.log('debris ' + (xhr.loaded) + ' loaded');
					var prc = Math.floor(xhr.loaded / 32162816 * 100);

				}
			);

			// this centers the glow at the mesh


			var ufoloader = new GLTFLoader(manager);
			ufoloader.load("models/SpaceshipJPG8.glb", function (gltf) {
				var ufo = gltf.scene;

				ufo.scale.set(40, 40, 40);

				ufo.position.set(-60, 60, -190);
				ufo.rotation.y = getRadian(-80);
				ufo.rotation.x = getRadian(5);


				ufo.visible = true;



				ufo.traverse(function (o) {
					if (o.isMesh) {
						console.log("UFO");
						if (o.name == 'Light') {
							o.material = new THREE.MeshBasicMaterial({color: 0xC440FF,opacity: 0.6,transparent: true,});
						} 
					}
				});

				scene1.add(ufo);

				var spriteMap = new THREE.TextureLoader().load("glow.png");
				var spriteMaterial = new THREE.SpriteMaterial(
					{
						map: spriteMap, useScreenCoordinates: false,
						color: 0xC440FF, transparent: true, blending: THREE.AdditiveBlending

					});
				var sprite = new THREE.Sprite(spriteMaterial);
				sprite.scale.set(2.5, 2.5, 1.0);
				sprite.position.set(0, 0.3, 0);
				ufo.add(sprite);
				var sprite2 = new THREE.Sprite(spriteMaterial);
				sprite2.scale.set(1.5, 1.5, 1.0);
				sprite2.position.set(0, -0.1, 0);
				ufo.add(sprite2);
					
				var pLight = new THREE.PointLight( 0xC440FF, 8 ,130 );
				pLight.rotation.x = getRadian(90);
				pLight.position.set(-60, 50, -190);
				scene1.add(pLight);

			},
				// called while loading is progressing
				function (xhr) {

					//console.log( ( xhr.loaded / xhr.total * 100 ) + '% loaded' );

				}
			);





		}

		function initScene2() {

			scene2loaded = true;
			scene2.add(controls.getObject());

			var light = new THREE.HemisphereLight(0xeeeeff, 0x777788, 1);
			light.position.set(0.5, 1, 0.75);
			scene2.add(light);

			var light1 = new THREE.PointLight(0xFFFFFF, 60, 100);
			light1.position.set(- 0, 35, 80);
			//scene2.add( light1 );

			var amblight = new THREE.AmbientLight(0xFFFFFF, 0.1);
			scene2.add(amblight);

			//scene2.add(ufo);

			var rocksloader = new GLTFLoader(manager);
			rocksloader.load("models/betonSpaceHD6.glb", function (gltf) {
				rocks = gltf.scene;

				//rocks.scale.set(0.05,0.05,0.05);

				rocks.position.set(0, 10, -250);
				rocks.rotation.y = getRadian(-80);
				rocks.rotation.x = getRadian(10);

				rocks.visible = true;

				rocks.traverse(function (o) {
					if (o.isMesh) {
						console.log("rocks " + o.name);
						if (o.name == 'FirePlanet') {
							o.scale.set(50, 50, 50);
							o.position.set(80, -30, -50);
						} else if (o.name == 'Sphere') {
							o.scale.set(600, 600, 600);
						} else if (o.name == "Moon") {
							o.scale.set(30, 30, 30);
							o.position.set(60, -50, 70);
						}
						else if (o.name.includes("Beton")) {

							rocksGeo.push(o.geometry);
							rocksMats.push(o.material);

							switch (o.name) {
								case 'Beton_1':
									o.position.set(160, 15, 110);
									break;
								case 'Beton_2':
									o.position.set(180, 0, -70);
									break;
								case 'Beton_3':
									o.position.set(160, -40, 40);
									break;
								case 'Beton_4':
									o.position.set(-100, 0, 100);
									break;
								case 'Beton_5':
									o.position.set(110, 50, -80);
									break;
							}

							o.scale.set(0.5, 0.5, 0.5);
						}
					}
				});


				var spriteMap = new THREE.TextureLoader().load("glow.png");
				var spriteMaterial = new THREE.SpriteMaterial(
					{
						map: spriteMap, useScreenCoordinates: false,
						color: 0xd31313, transparent: true, blending: THREE.AdditiveBlending

					});
				var sprite = new THREE.Sprite(spriteMaterial);
				sprite.scale.set(140, 140, 1.0);
				sprite.position.set(80, -30, -50);
				rocks.add(sprite);

				var spriteMaterial2 = new THREE.SpriteMaterial(
					{
						map: spriteMap, useScreenCoordinates: false,
						color: 0x1eff00, transparent: true, blending: THREE.AdditiveBlending

					});
				var sprite2 = new THREE.Sprite(spriteMaterial2);
				sprite2.scale.set(80, 80, 1.0);
				sprite2.position.set(60, -50, 70);
				rocks.add(sprite2);


				scene2.add(rocks);
				console.log('rocks added to scene');
				rocksGeo.forEach(makeInstancedRocks);

				loaded();
			},
				// called while loading is progressing
				function (xhr) {
					console.log('rocks ' + (xhr.loaded) + ' loaded');
					var prc = Math.floor(xhr.loaded / 7119612 * 100);

					updateLoadBar(prc);
				}
			);

			var ufoloader = new GLTFLoader(manager);
			ufoloader.load("models/SpaceshipJPG3.glb", function (gltf) {
				var ufo = gltf.scene;

				ufo.scale.set(30, 30, 30);

				ufo.position.set(-50, 60, -250);
				ufo.rotation.y = getRadian(-80);
				ufo.rotation.x = getRadian(4);

				ufo.visible = true;

				ufo.traverse(function (o) {
					if (o.isMesh) {
						console.log("UFO");
					}
				});
				scene2.add(ufo);

				var spriteMap = new THREE.TextureLoader().load("glow.png");
				var spriteMaterial = new THREE.SpriteMaterial(
					{
						map: spriteMap, useScreenCoordinates: false,
						color: 0xC440FF, transparent: true, blending: THREE.AdditiveBlending

					});
				var sprite = new THREE.Sprite(spriteMaterial);
				sprite.scale.set(2.2, 2.2, 1.0);
				sprite.position.set(0, 0.2, 0);
				ufo.add(sprite);

				console.log('ufo added to scene');
				$("#loadText").html('loaded<br>');
			},
				// called while loading is progressing
				function (xhr) {
					console.log('ufo ' + (xhr.loaded) + ' loaded');
					var prc = Math.floor(xhr.loaded / 2561968 * 100);

				}
			);

			/*
			
			var uniforms = {  
			texture: { type: 't', value: THREE.ImageUtils.loadTexture('textures/Nebula.png') }
			};
			
			var material = new THREE.ShaderMaterial( {  
			uniforms:       uniforms,
			vertexShader:   document.getElementById('sky-vertex').textContent,
			fragmentShader: document.getElementById('sky-fragment').textContent
			});
			*/
			var material = new THREE.MeshBasicMaterial();
			material.map = new THREE.TextureLoader().load("textures/Nebula.png");
			material.color = new THREE.Color(0xFFFFFF);
			material.side = THREE.BackSide;
			var sky = new THREE.Mesh(new THREE.SphereGeometry(700, 60, 40), material);
			sky.rotation.y = getRadian(100);
			//scene2.add(sky); 

		}

		function initScene3() {

			scene3loaded = true;
			scene3.add(controls.getObject());



			var amblight = new THREE.AmbientLight(0x02FD01, 0.1); // soft white light
			scene3.add(amblight);

			var light2 = new THREE.PointLight(0xFFFFFF, 3, 1600);
			light2.position.set(0.5, 15, 3);
			light2.castShadow = true;
			scene3.add(light2);

			var light3 = new THREE.PointLight(0xFFFFFF, 1, 1600);
			light3.position.set(-80, 15, 200);
			light3.castShadow = true;
			scene3.add(light3);

			var moonloader = new GLTFLoader(manager);
			moonloader.load("models/moon9.glb", function (gltf) {
				var moon = gltf.scene;

				moon.scale.set(0.8, 0.8, 0.8);

				//moon.position.set(- 160, 6, 80);
				moon.rotation.y = getRadian(-90);

				moon.visible = true;



				moon.traverse(function (o) {
					if (o.isMesh) {
						console.log("moon");
						o.receiveShadow = true;
					}
				});
				scene3.add(moon);
				loaded();
			},
				// called while loading is progressing
				function (xhr) {
					console.log('moon ' + (xhr.loaded) + '% loaded');
					var prc = Math.floor(xhr.loaded / 3027156 * 100);

					updateLoadBar(prc);
				}
			);

			var doorloader = new GLTFLoader(manager);
			doorloader.load("models/DoorRetopo.glb", function (gltf) {
				var door = gltf.scene;

				door.scale.set(5, 5, 5);

				door.position.set(-30, 0, 0);
				door.rotation.y = getRadian(-45);

				door.visible = true;



				door.traverse(function (o) {
					if (o.isMesh) {
						console.log("door");
						o.castShadow = true;
					}
				});
				scene3.add(door);
				loaded();
			},
				// called while loading is progressing
				function (xhr) {
					console.log('door ' + (xhr.loaded) + '% loaded');
					var prc = Math.floor(xhr.loaded / 3027156 * 100);

				}
			);

			var Statueloader = new GLTFLoader(manager);
			Statueloader.load("models/StatuesAnim3.glb", function (gltf) {
				var Statue = gltf.scene;

				Statue.scale.set(8, 8, 8);

				Statue.position.set(15, 0, 0);
				Statue.rotation.y = getRadian(260);


				Statue.visible = true;

				Statue.traverse(function (o) {
					
					if (o.isMesh) {
						console.log(o.name);
						o.castShadow = true;
						//o.rotation.y = getRadian(90);
						//o.rotation.x = getRadian(90);


					}
				});

				mixer = new THREE.AnimationMixer(gltf.scene);
				mixer.clipAction(gltf.animations[0]).play();	
				mixer.timeScale = 1.3;

				scene3.add(Statue);
				loaded();
			},
				// called while loading is progressing
				function (xhr) {
					console.log('Statue ' + (xhr.loaded) + 'B loaded');
					var prc = Math.floor(xhr.loaded / 10260068 * 100);

				}
			);

			var Statue2loader = new GLTFLoader(manager);
			Statue2loader.load("models/StatuesAnim2.glb", function (gltf) {
				var Statue2 = gltf.scene;

				Statue2.scale.set(8, 8, 8);

				Statue2.position.set(-5, -0.4, -15);
				Statue2.rotation.y = getRadian(180);

				Statue2.visible = true;

				Statue2.traverse(function (o) {
					if (o.isMesh) {
						console.log(o.name);
						o.castShadow = true;
						//o.rotation.y = getRadian(90);
						//o.rotation.x = getRadian(90);
					}
				});

				mixer2 = new THREE.AnimationMixer(gltf.scene);
				mixer2.clipAction(gltf.animations[0]).play();
				mixer2.timeScale = 1.3;

				scene3.add(Statue2);
				loaded();
			},
				// called while loading is progressing
				function (xhr) {
					console.log('Statue2 ' + (xhr.loaded) + 'B loaded');
					var prc = Math.floor(xhr.loaded / 10260068 * 100);

				}
			);

			var Statue3loader = new GLTFLoader(manager);
			Statue3loader.load("models/StatuesAnim1.glb", function (gltf) {
				var Statue3 = gltf.scene;

				Statue3.scale.set(8, 8, 8);

				Statue3.position.set(-17, -0.4, 18);
				Statue3.rotation.y = getRadian(0);

				Statue3.visible = true;

				Statue3.traverse(function (o) {
					if (o.isMesh) {
						console.log(o.name);
						o.castShadow = true;
						//o.rotation.y = getRadian(90);
						//o.rotation.x = getRadian(90);
					}
				});

				mixer3 = new THREE.AnimationMixer(gltf.scene);
				mixer3.clipAction(gltf.animations[0]).play();
				mixer3.timeScale = 1.3;

				scene3.add(Statue3);
				loaded();
			},
				// called while loading is progressing
				function (xhr) {
					console.log('Statue3 ' + (xhr.loaded) + 'B loaded');
					var prc = Math.floor(xhr.loaded / 10260068 * 100);

				}
			);



			/*
			
			var uniforms = {  
			texture: { type: 't', value: THREE.ImageUtils.loadTexture('textures/Nebula.png') }
			};
			
			var material = new THREE.ShaderMaterial( {  
			uniforms:       uniforms,
			vertexShader:   document.getElementById('sky-vertex').textContent,
			fragmentShader: document.getElementById('sky-fragment').textContent
			});
			*/
			var texture = new THREE.TextureLoader().load("textures/Aurora3.png");
			var material = new THREE.MeshPhongMaterial({color: 0x000000, alphaMap: texture, transparent: true, opacity: 0.6});
			var material2 = new THREE.MeshBasicMaterial();
			material2.map = texture;
			material.map = texture;
			material2.side = THREE.BackSide;
			material.color = new THREE.Color(0xFFFFFF);
			material.side = THREE.BackSide;
			gasSphere = new THREE.Mesh(new THREE.SphereGeometry(70, 60, 40), material);
			var tsph = new THREE.Mesh(new THREE.SphereGeometry(80, 60, 40), material2);
			scene3.add(gasSphere);
			scene3.add(tsph);
		}

		function init() {
			//clock = new THREE.Clock();
			camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1500);
			camera.position.y = 10;
			camera.position.z = 30;
			scene = new THREE.Scene();

			scene1 = new THREE.Scene();
			scene2 = new THREE.Scene();
			scene3 = new THREE.Scene();

			currentScene = scene2;

			//ufo = new THREE.Object3D();
			scene.background = new THREE.Color(0x000000);
			//scene1.background = new THREE.Color( 0x000000);
			//scene.fog = new THREE.Fog( 0xffffff, 0, 750 );
			scene1.fog = new THREE.Fog(0x000000, 0, 400);
			//scene2.fog = new THREE.Fog(0xD1D1D1, 0, 6000);
			scene3.fog = new THREE.Fog(0x02FD01, 0, 200);

			var light = new THREE.HemisphereLight(0xeeeeff, 0x777788, 2);
			light.position.set(0.5, 3, 0.75);
			scene.add(light);



			controls = new PointerLockControls(camera, document.body);

			var blocker = document.getElementById('blocker');
			var instructions = document.getElementById('instructions');
			crossHair = document.getElementById('crossHair');
			/*
			var footer = document.getElementById( 'footer' );
			
			footer.addEventListener( 'click', switchScenes, false );
*/





			$('#footer a').click(function (e) {
				var txt = $(e.target).text();
				console.log(txt);
				controls.unlock();

				goToScene(txt);
				blocker.style.display = 'block';
				instructions.style.display = 'block';
				transition = true;
				//controls.unlock();					
			});




			instructions.addEventListener('click', function () {

				controls.lock();

				transition = true;


			}, false);

			document.body.addEventListener('touchstart', function (e) {
				e.preventDefault();

				controls.lock();
				console.log("touchstart");
				instructions.style.display = 'none';
				blocker.style.display = 'none';
				transition = false;


			}, false);


			controls.addEventListener('lock', function () {

				instructions.style.display = 'none';
				blocker.style.display = 'none';

				transition = false;

				var listener = new THREE.AudioListener();
				camera.add(listener);
				// create a global audio source
				var sound = new THREE.Audio(listener);
				// load a sound and set it as the Audio object's buffer
				var audioLoader = new THREE.AudioLoader();
				audioLoader.load('ambient.ogg', function (buffer) {
					sound.setBuffer(buffer);
					sound.setLoop(true);
					sound.setVolume(0.5);
					sound.play();
				});

			});

			controls.addEventListener('unlock', function () {

				blocker.style.display = 'block';
				instructions.style.display = '';

				transition = true;

			});

			scene2.add(controls.getObject());

			var onKeyDown = function (event) {
				if (transition == false) {
					switch (event.keyCode) {

						case 38: // up
						case 87: // w
							moveForward = true;
							break;

						case 37: // left
						case 65: // a
							moveLeft = true;
							break;

						case 40: // down
						case 83: // s
							moveBackward = true;
							break;

						case 39: // right
						case 68: // d
							moveRight = true;
							break;

						case 32: // space
							if (canJump === true) velocity.y += 250;
							canJump = false;
							break;

					}
				}
				else {
					moveForward = false;
					moveLeft = false;
					moveBackward = false;
					moveRight = false;
				}

			};

			var onKeyUp = function (event) {

				switch (event.keyCode) {

					case 38: // up
					case 87: // w
						moveForward = false;
						break;

					case 37: // left
					case 65: // a
						moveLeft = false;
						break;

					case 40: // down
					case 83: // s
						moveBackward = false;
						break;

					case 39: // right
					case 68: // d
						moveRight = false;
						break;

				}

			};



			document.addEventListener('keydown', onKeyDown, false);
			document.addEventListener('keyup', onKeyUp, false);
			document.addEventListener('mousemove', onDocumentMouseMove, false);
			document.addEventListener('mousedown', onDocumentMouseDown, false);


			raycaster = new THREE.Raycaster();
			mouse = new THREE.Vector2();

			//raycaster = new THREE.Raycaster(new THREE.Vector3(), new THREE.Vector3(0, - 1, 0), 0, 10);

			//initPaintings();


			initScene2();

			var fireTex = new THREE.TextureLoader().load("./Fire.png");
			fire = new Fire(fireTex);
			fire.scale.set(25, 25, 25);
			fire.position.set(0, 10, -30);
			scene1.add(fire);
			fire2 = new Fire(fireTex);
			fire2.scale.set(25, 25, 25);
			fire2.position.set(-40, 10, -30);
			scene1.add(fire2);
			fire3 = new Fire(fireTex);
			fire3.scale.set(40, 40, 40);
			fire3.position.set(40, 20, -110);
			scene1.add(fire3);
			fire.name = "Fire";
			fire2.name = "Fire";
			fire3.name = "Fire";

			renderer = new THREE.WebGLRenderer({ antialias: true });
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(window.innerWidth, window.innerHeight);

			//renderer.toneMapping = THREE.ReinhardToneMapping;
			//renderer.toneMappingExposure = 2.3;

			renderer.shadowMap.enabled = true;
			renderer.shadowMap.type = THREE.BasicShadowMap;
			//renderer.gammaOutput = true;
			//renderer.gammaFactor = 2.2;

			document.body.appendChild(renderer.domElement);


			window.addEventListener('resize', onWindowResize, false);


		}

		function onWindowResize() {
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize(window.innerWidth, window.innerHeight);
		}

		var randomizeMatrix = function () {

			var position = new THREE.Vector3();
			var rotation = new THREE.Euler();
			var quaternion = new THREE.Quaternion();
			var scale = new THREE.Vector3();

			return function (matrix) {

				position.x = 0;
				position.y = Math.random() * 260 - 130;
				position.z = Math.random() * 260 - 130;

				//rotation.x = Math.random() * 2 * Math.PI;
				//rotation.y = Math.random() * 2 * Math.PI;
				rotation.z = Math.random() * 2 * Math.PI;

				rotation.z = getRadian(90);


				quaternion.setFromEuler(rotation);
				var max = 0.5;
				var min = 0.1;
				scale.x = scale.y = scale.z = Math.random() * (max - min) + min;

				matrix.compose(position, quaternion, scale);

			};

		}();


		var randomizeMatrixRocks = function () {

			var position = new THREE.Vector3();
			var rotation = new THREE.Euler();
			var quaternion = new THREE.Quaternion();
			var scale = new THREE.Vector3();

			return function (matrix) {

				position.x = Math.random() * 260 - 130;
				position.y = Math.random() * 260 - 130;
				position.z = 0;

				//rotation.x = Math.random() * 2 * Math.PI;
				//rotation.y = Math.random() * 2 * Math.PI;
				rotation.z = Math.random() * 2 * Math.PI;

				rotation.y = getRadian(90);


				quaternion.setFromEuler(rotation);
				var max = 0.5;
				var min = 0.1;
				scale.x = scale.y = scale.z = 0.01;

				matrix.compose(position, quaternion, scale);

			};

		}();

		function makeInstanced(geometry, material) {
			var count = 300;
			var matrix = new THREE.Matrix4();
			var mesh = new THREE.InstancedMesh(geometry, material, count);

			for (var i = 0; i < count; i++) {

				randomizeMatrix(matrix);
				mesh.setMatrixAt(i, matrix);

			}
			mesh.rotation.z = getRadian(90);
			mesh.position.set(0, -1, 0);
			scene1.add(mesh);

		}

		function makeInstancedRock(geometry, material) {
			var count = 1;
			var matrix = new THREE.Matrix4();
			var mesh = new THREE.InstancedMesh(geometry, material, count);

			var position = new THREE.Vector3();
			var rotation = new THREE.Euler();
			var quaternion = new THREE.Quaternion();
			var scale = new THREE.Vector3();

			position.x = Math.random() * 60 - 30;
			position.y = 0;
			position.z = Math.random() * 60 - 30;

			rotation.x = 0;
			rotation.y = 0;
			//rotation.z = Math.random() * 2 * Math.PI;
			rotation.z = 0;
			rotation.x = getRadian(90);

			quaternion.setFromEuler(rotation);
			var max = 0.05;
			var min = 0.01;
			scale.x = scale.y = scale.z = 0.1;


			matrix.compose(position, quaternion, scale);

			mesh.setMatrixAt(0, matrix);

			//mesh.scale.set(1,1,1);
			//mesh.rotation.x = getRadian(90);
			mesh.position.set(0, -0.2, 0);
			//mesh.castShadow = true;
			scene3.add(mesh);
			//scene1.add(mesh);

		}

		function makeInstancedRocks(item, i) {
			makeInstancedRock(rocksGeo[i], rocksMats[i]);
		}

		function onDocumentMouseMove(event) {

			//mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
			//mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;

			mouse.x = 0;
			mouse.y = 0;
			raycaster.setFromCamera(mouse, camera);
			var intersects = raycaster.intersectObjects(currentScene.children, true);
			var oName = intersects[0].object.name;
			if (oName == "Fire" && intersects.length > 1) oName = intersects[1].object.name;
			if (intersects.length > 0) {
				//console.log("hover" + oName);

				if (oName == "FirePlanet" || oName == "Ship" || oName == "Emmisive" || oName == "Moon" || oName == "Plane002") crossHair.style.display = 'block';
				else crossHair.style.display = 'none';

				$('html,body').css('cursor', 'pointer');
			} else {
				crossHair.style.display = 'none';
				$('html,body').css('cursor', 'default');
			}

		}


		function onDocumentMouseDown(event) {
			event.preventDefault();
			var e = event;
			//if (e.stopPropagation) e.stopPropagation();
			if (e.preventDefault) e.preventDefault();
			e.cancelBubble = true;
			e.returnValue = false;

			if (blocker.style.display == 'block') {
				//initTrans();
				return;
			}
			if (isMobile == false) {
				mouse.x = 0;
				mouse.y = 0;
			} else {
				mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
				mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
			}




			raycaster.setFromCamera(mouse, camera);
			var intersects = raycaster.intersectObjects(currentScene.children, true);
			var to;

			var o;
			o = intersects[0].object;
			if (o.name == "Fire" && intersects.length > 1) o = intersects[1].object;
			if (intersects.length > 0) {

			}
			if (intersects.length > 0/* && clickable.includes(intersects[0].object.name)*/) {
				if (transition == false && blocker.style.display == 'none') clicker(o);
				//lightbox_open();
				//animateMove(camera.position,{x: to.position.x - 2, y: to.position.y,z: to.position.z + 0.5},to.position,1000);
			}
		}
		function clicker(o) {
			console.log(o.name);
			moveForward = false;

			moveLeft = false;

			moveBackward = false;

			moveRight = false;

			switch (o.name) {
				case "FirePlanet":
					goToScene("Fire");
					controls.unlock();
					blocker.style.display = 'block';
					instructions.style.display = 'block';
					transition = true;
					brek;
				case "Ship":
					goToScene("UFO");
					controls.unlock();
					blocker.style.display = 'block';
					instructions.style.display = 'block';
					transition = true;
					break;
				case "Emmisive":
					goToScene("UFO");
					controls.unlock();
					blocker.style.display = 'block';
					instructions.style.display = 'block';
					transition = true;
					break;
				case "Moon":
					goToScene("AtomGas");
					controls.unlock();
					blocker.style.display = 'block';
					instructions.style.display = 'block';
					transition = true;
					break;
				case "Plane002":
					if (index == 1) {
						goToScene("AtomGas");
					} else if (index == 3) {
						goToScene("Fire");
					}  else if (index == 0) {
						goToScene("AtomGas");
					}


					controls.unlock();
					blocker.style.display = 'block';
					instructions.style.display = 'block';
					transition = true;
					break;
			}

		}





		var t = 0;

		function animate() {

			requestAnimationFrame(animate);
			t = t + 0.01;
			if (index == 1) {
				fire.update(t);
				fire2.update(t);
				fire3.update(t);
			}

			if (rocks != null && index == 2) rocks.traverse(function (o) {
				if (o.isMesh & o.name.includes("Beton")) {
					o.rotation.x += 0.0009;
					o.rotation.z -= 0.0008;
					
				}
			});
			if(gasSphere != null && index == 3){
				gasSphere.rotation.x -= 0.0008;
				gasSphere.rotation.y -= 0.002;
			}

			if (controls.isLocked === true) {

				raycaster.ray.origin.copy(controls.getObject().position);
				raycaster.ray.origin.y -= 10;

				var intersections = raycaster.intersectObjects(objects);

				var onObject = intersections.length > 0;

				var time = performance.now();
				var delta = (time - prevTime) / 1000;

				if (mixer) mixer.update(delta);
				if (mixer2) mixer2.update(delta);
				if (mixer3) mixer3.update(delta);

				velocity.x -= velocity.x * 10.0 * delta;
				velocity.z -= velocity.z * 10.0 * delta;

				velocity.y -= 9.8 * 100.0 * delta; // 100.0 = mass

				direction.z = Number(moveForward) - Number(moveBackward);
				direction.x = Number(moveRight) - Number(moveLeft);
				direction.normalize(); // this ensures consistent movements in all directions

				if (moveForward || moveBackward) velocity.z -= direction.z * 400.0 * delta;
				if (moveLeft || moveRight) velocity.x -= direction.x * 400.0 * delta;

				if (onObject === true) {

					velocity.y = Math.max(0, velocity.y);
					canJump = true;

				}

				controls.moveRight(- velocity.x * delta);
				controls.moveForward(- velocity.z * delta);


				controls.getObject().position.y += (velocity.y * delta); // new behavior

				if (controls.getObject().position.y < 10) {

					velocity.y = 0;
					controls.getObject().position.y = 10;

					canJump = true;

				}

				prevTime = time;

			} else {

				direction.x = 0;
				direction.y = 0;
				velocity.y = 0;
				velocity.x = 0;
				moveForward = false;
			}

			renderer.render(currentScene, camera);
			//composer.render();
		}

	</script>




	<div id="footer">

		<a>Space</a> <a>Fire</a> <a>UFO</a> <a>AtomGas</a>

	</div>

</body>

</html>